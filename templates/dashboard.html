<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Evolution Dashboard & Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-slate-900 text-white font-sans h-screen flex flex-col overflow-hidden">

    <div class="bg-slate-800 border-b border-slate-700 p-4 flex justify-between items-center shrink-0">
        <div>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-indigo-400">
                Guy Heart Photography AI ðŸ“·
            </h1>
            <p class="text-xs text-slate-400">Style & Tone Training Dashboard</p>
        </div>
        <div class="flex gap-3">
             <button onclick="fetchLogs()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-sm flex items-center gap-2 transition">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh Logs
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-1/2 flex flex-col border-r border-slate-700 overflow-y-auto p-6 bg-slate-900">
            
            <div class="mb-8 bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-lg">
                <h2 class="text-sm font-semibold mb-2 text-emerald-400 flex items-center gap-2">
                    <i data-lucide="cpu" class="w-4 h-4"></i> Current System Instructions
                </h2>
                <div class="bg-black/50 p-3 rounded-lg font-mono text-xs text-slate-300 whitespace-pre-wrap h-32 overflow-y-auto" id="current-prompt">
                    Loading active prompt...
                </div>
            </div>

            <h2 class="text-sm font-semibold mb-4 text-slate-400 flex items-center gap-2">
                <i data-lucide="history" class="w-4 h-4"></i> Recent Improvements
            </h2>
            <div id="logs-container" class="space-y-4 pb-10">
                <div class="text-center text-slate-600 text-sm">Waiting for training data...</div>
            </div>
        </div>

        <div class="w-1/2 flex flex-col bg-slate-950">
            <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                <h2 class="font-semibold text-blue-400 flex items-center gap-2">
                    <i data-lucide="message-square" class="w-4 h-4"></i> Test the AI
                </h2>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex justify-start">
                    <div class="bg-slate-800 rounded-lg rounded-tl-none p-3 max-w-[80%] text-sm text-slate-300">
                        Hello! I am your AI. Train me on the left, then test me here!
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-900 border-t border-slate-800">
                <form onsubmit="sendMessage(event)" class="flex gap-2">
                    <input type="text" id="user-input" 
                        class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500 transition"
                        placeholder="Ask something (e.g., What are your wedding packages?)..." autocomplete="off">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        Send <i data-lucide="send" class="w-3 h-3"></i>
                    </button>
                </form>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();
        let chatHistory = []; // Local history for the chat session

        // --- 1. Chat Logic ---
        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            // Add User Message to UI
            appendMessage('user', message);
            input.value = '';

            try {
                // Call Backend
                const response = await fetch('/generate-reply', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        clientSequence: message,
                        chatHistory: chatHistory
                    })
                });
                const data = await response.json();

                if (data.aiReply) {
                    appendMessage('ai', data.aiReply);
                    
                    // Update History
                    chatHistory.push({ role: 'client', message: message });
                    chatHistory.push({ role: 'consultant', message: data.aiReply });
                } else {
                    appendMessage('error', 'Error: ' + JSON.stringify(data));
                }

            } catch (err) {
                appendMessage('error', 'Failed to connect to server.');
            }
        }

        function appendMessage(role, text) {
            const chatBox = document.getElementById('chat-box');
            let div = document.createElement('div');
            
            if (role === 'user') {
                div.className = "flex justify-end";
                div.innerHTML = `<div class="bg-blue-600 text-white rounded-lg rounded-tr-none p-3 max-w-[80%] text-sm whitespace-pre-wrap">${text}</div>`;
            } else if (role === 'ai') {
                // Configure marked to handle line breaks correctly
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });
                const htmlContent = marked.parse(text);
                
                div.className = "flex justify-start";
                // We add 'prose' (or custom styles) to handle markdown elements like headers/tables inside the bubble
                // REMOVED: whitespace-pre-wrap (we rely on HTML tags now)
                div.innerHTML = `
                    <div class="bg-slate-800 text-slate-200 rounded-lg rounded-tl-none p-3 max-w-[90%] text-sm shadow-md overflow-x-auto">
                        <style>
                            table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; margin-bottom: 0.5rem; }
                            th, td { border: 1px solid #475569; padding: 0.5rem; text-align: left; vertical-align: top; }
                            th { background-color: #334155; font-weight: 600; color: #e2e8f0; }
                            tr:nth-child(even) { background-color: #1e293b; }
                            ul { list-style-type: disc; margin-left: 1.5rem; }
                            ol { list-style-type: decimal; margin-left: 1.5rem; }
                            strong { color: #f8fafc; font-weight: 700; }
                            p { margin-bottom: 0.5rem; last:margin-bottom:0; }
                        </style>
                        ${htmlContent}
                    </div>`;
            } else {
                div.className = "flex justify-center";
                div.innerHTML = `<div class="text-red-400 text-xs">${text}</div>`;
            }

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
        }

        // --- 2. Dashboard Logic ---
        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                document.getElementById('current-prompt').innerText = data.current_prompt;
                const container = document.getElementById('logs-container');
                container.innerHTML = ''; 

                data.logs.forEach(log => {
                    let clientSeq = log.client_sequence;
                    try { if (typeof clientSeq === 'string') clientSeq = JSON.parse(clientSeq); } catch(e) {}
                    let reasoning = log.editor_result?.reasoning || "Optimized.";

                    const card = `
                        <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 text-xs">
                            <div class="font-bold text-slate-500 mb-1">Q: "${clientSeq}"</div>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div><span class="text-red-400 block mb-1">Old AI:</span> <span class="text-slate-500 line-through">${log.predicted_reply.substring(0,50)}...</span></div>
                                <div><span class="text-emerald-400 block mb-1">Human:</span> <span class="text-emerald-100">${log.consultant_reply.substring(0,50)}...</span></div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-slate-700 text-blue-300 italic">"Learned: ${reasoning}"</div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
                lucide.createIcons();
            } catch (error) { console.error(error); }
        }

        // Init
        fetchLogs();
        // Auto-refresh logs every 5 seconds
        setInterval(fetchLogs, 5000); 
    </script>
</body>
</html>